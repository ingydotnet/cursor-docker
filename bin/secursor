#!/usr/bin/env bash

set -euo pipefail

help() (
  cat <<'...'
Usage: secursor [options] [repo]

Options:
      --start         Start the container (default)
  -S, --stop          Stop the container
  -R, --restart       Restart the container
  -B, --rebuild       Rebuild the container image
  -h, --help          Show this help message
  -v, --version       Show the version

...
)

main() (
  init

  if [[ ${1-} == -* ]]; then
    action "$@"
    exit
  fi

  [[ $# -gt 0 ]] || set -- "$(pwd -P)"

  setup "$@"; shift

  cd "$repo" ||
    die "Failed to cd to repo: $repo"

  export SECURSOR_DOCKERFILE=$root/Dockerfile
  export SECURSOR_ARGS="$*"

  make -e -f "$root/Makefile" start "$@"
)

action() (
  action=$1; shift
  [[ $# -gt 0 ]] || set -- "$(pwd -P)"

  case $action in
    -h|--help)
      help
      exit
      ;;
    -v|--version)
      make --no-print-directory -f "$root/Makefile" version
      exit
      ;;
    --start)
      make -e -f "$root/Makefile" start
      ;;
    -S|--stop)
      make -e -f "$root/Makefile" stop
      ;;
    -R|--restart)
      make -e -f "$root/Makefile" stop start
      ;;
    -B|--rebuild)
      setup "$@"
      make -e -f "$root/Makefile" stop
      rm -fr "$gitdir/.ext"
      secursor "$@"
      ;;
    *)
      die "Unknown action flag: $1";;
  esac
)

init() {
  [[ ${SECURSOR_ROOT:-} ]] ||
    die 'SECURSOR_ROOT is not set' \
        'Try: source /path/to/secursor/.rc'
  root=$SECURSOR_ROOT
}

setup() {
  [[ -d $root ]] ||
    die "SECURSOR_ROOT is not a directory: $root"
  { [[ -f $root/Makefile ]] &&
    [[ -f $root/Dockerfile ]]
  } || die "SECURSOR_ROOT is not the SECursor project: $root"

  repo=$1
  [[ $repo ]] ||
    die 'No repo directory provided'
  [[ -d $repo ]] ||
    die "Repo directory does not exist: $repo"
  gitdir=$(cd "$repo" && git rev-parse --git-common-dir 2>/dev/null)
  [[ $gitdir ]] ||
    die "Repo is not a git repository: $repo"
  [[ -d $gitdir ]] ||
    die "Git directory does not exist: $gitdir"
  [[ $gitdir == *.git && -d $gitdir ]] ||
    die "Git directory is not a git repository: $gitdir"
  repo=$(cd "$repo" && pwd -P)
  gitdir=$(cd "$gitdir" && pwd -P)
}

die() {
  local msg=${1:-' died'}; shift
  msg="Error: $msg"
  printf '%s\n' "$msg" "$@" >&2
  exit 1
}

main "$@"
